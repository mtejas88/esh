/*
Author: Greg Kurzhals
Created On Date: 11/02/2015
Last Modified Date: 12/04/2015
Name of QAing Analyst(s): 
Purpose: Returns the list of recipients (including name, id, type, and district_esh_id) of a specified line item
Methodology: Subquery creates a universal list of entities (i.e. all districts, schools, and other locations), and joins this list to the allocations table - Liquid parameter 
template allows user to limit results to a single line item
Dependencies: N/A
*/


select a.id,
a.line_item_id,
a.recipient_id,
a.recipient_type,
a.recipient_ben,
a.recipient_name,
a.num_lines_to_allocate,
b.district_esh_id,
c.name,
c.num_schools,
c.num_students,
c.include_in_universe_of_districts

from allocations a

--commonly used sub-query that returns list of all entities with associated district_esh_id and postal_cd
left join lateral (select esh_id, district_esh_id, postal_cd
  from schools
  union
  select esh_id, esh_id as district_esh_id, postal_cd
  from districts
  union
  select esh_id, district_esh_id, postal_cd
  from other_locations
  where district_esh_id is not null) b
on a.recipient_id=b.esh_id

left join districts c
on b.district_esh_id=c.esh_id

--where statement limits results to user-entered line_item_id

where a.line_item_id='{{line_item_id}}'
ORDER BY b.district_esh_id, c.include_in_universe_of_districts

{% form %}

line_item_id:
  type: text
  default: '377986' 
  
{% endform %}
