/*Author: Greg Kurzhals 
Created On Date: 01/11/2016 
Last Modified Date:  
Name of QAing Analyst(s):  
Purpose: summarizes bundled Internet cost/mbps and WAN cost/connection on a circuit-level for each state, stratified by bandwidth range and by lit fiber vs. all conn. types
Methodology: 

min, 10th, 25th, median, 75th, 90th, max, mean, line item n, circuit n
for the following data points -

1) cost/connection (WAN):
Pure WAN
Pure WAN 0-100 mbps
Pure WAN 100 mbps - 1 G
Pure WAN 1 G - 10 G
Pure WAN 10 G+
Lit Fiber WAN 0-100 mbps
Lit Fiber WAN 100 mbps - 1 G
Lit Fiber WAN 1 G - 10 G
Lit Fiber WAN 10 G+

2) cost/mbps (bundled Internet):
Pure Internet
Pure Internet 0-100 mbps
Pure Internet 100 mbps - 1 G
Pure Internet 1 G - 10 G
Pure Internet 10 G+
Lit Fiber Internet 0-100 mbps
Lit Fiber Internet 100 mbps - 1 G
Lit Fiber Internet 1 G - 10 G
Lit Fiber Internet 10 G+
*/


with district_lookup as (
  select esh_id, district_esh_id, postal_cd
  from schools
  union
  select esh_id, esh_id as district_esh_id, postal_cd
  from districts
  union
  select esh_id, district_esh_id, postal_cd
  from other_locations
  where district_esh_id is not null
),
ad as (
  select district_esh_id, a.*
  from allocations a
  join district_lookup dl
  on dl.esh_id = a.recipient_id
),

circuit_list as (select c.id,
c.line_item_id,
c.service_provider_id,
line_items.applicant_postal_cd,
c.connect_type,
c.connect_category,
c.num_recipients,
c.bandwidth_in_mbps,
c.circuit_cost,
c.orig_r_months_of_service,
c.ia_conditions_met,
c.wan_conditions_met,
c.internet_conditions_met,
c.isp_conditions_met,
c.upstream_conditions_met,
c.number_of_dirty_line_item_flags,
c.open_flags,
c.exclude_from_reporting,
c.consortium_shared

from circuits c

left join line_items
on c.line_item_id=line_items.id

where (c.internet_conditions_met=true OR c.wan_conditions_met=true)
and c.line_item_id in (

select line_items.id
from line_items

where exists (
    select *
    from ad
    left join districts
    on ad.district_esh_id = districts.esh_id
    where line_items.id = ad.line_item_id
    and districts.include_in_universe_of_districts=true
      
)
and broadband = true
and exclude=false
and rec_elig_cost!='No data'
and rec_elig_cost::numeric >0)
and c.id in (
select entity_circuits.circuit_id 
from entity_circuits
left join ad
on entity_circuits.entity_id=ad.recipient_id
where ad.district_esh_id in (
select esh_id
from districts
where include_in_universe_of_districts=true))
ORDER BY c.line_item_id),


cl_pure_internet as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true

ORDER BY circuit_cost),


cl_pure_internet_under_100_mbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100

ORDER BY circuit_cost),



cl_pure_internet_100_mbps_to_1_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000

ORDER BY circuit_cost),



cl_pure_internet_1_Gbps_to_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000

ORDER BY circuit_cost),



cl_pure_internet_over_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000

ORDER BY circuit_cost),


cl_lf_internet as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and connect_category='Fiber'

ORDER BY circuit_cost),

cl_lf_internet_under_100_mbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_internet_100_mbps_to_1_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_internet_1_Gbps_to_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_internet_over_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost,
(circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 as "cost_per_mbps"

from circuit_list

where internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

agg_functions_ia as (

select circuit_list.applicant_postal_cd as "state",

min(case when internet_conditions_met=true then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_internet_cost_per_mbps",
avg(case when internet_conditions_met=true then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_internet_cost_per_mbps",
max(case when internet_conditions_met=true then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_internet_cost_per_mbps",
sum(case when internet_conditions_met=true then 1 else 0 end) as "internet_circuits_n",
count(distinct (case when internet_conditions_met=true then line_item_id else null end)) as "internet_line_items_n",  

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_internet_cost_per_mbps_under_100_mbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_internet_cost_per_mbps_under_100_mbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_internet_cost_per_mbps_under_100_mbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 then 1 else 0 end) as "internet_circuits_under_100_mbps_n",
count(distinct (case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 then line_item_id else null end)) as "internet_line_items_under_100_mbps_n",

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_internet_cost_per_mbps_100_mbps_to_1_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_internet_cost_per_mbps_100_mbps_to_1_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_internet_cost_per_mbps_100_mbps_to_1_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then 1 else 0 end) as "internet_circuits_100_mbps_to_1_Gbps_n",
count(distinct (case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then line_item_id else null end)) as "internet_line_items_100_mbps_to_1_Gbps_n",

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then 1 else 0 end) as "internet_circuits_1_Gbps_to_10_Gbps_n",
count(distinct (case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then line_item_id else null end)) as "internet_line_items_1_Gbps_to_10_Gbps_n",

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_internet_cost_per_mbps_over_10_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_internet_cost_per_mbps_over_10_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_internet_cost_per_mbps_over_10_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 then 1 else 0 end) as "internet_circuits_over_10_Gbps_n",
count(distinct (case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 then line_item_id else null end)) as "internet_line_items_over_10_Gbps_n",


min(case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_lit_fiber_internet_cost_per_mbps",
avg(case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_lit_fiber_internet_cost_per_mbps",
max(case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_lit_fiber_internet_cost_per_mbps",
sum(case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_internet_circuits_n",
count(distinct (case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service'then line_item_id else null end)) as "lit_fiber_internet_line_items_n",  

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_lit_fiber_internet_cost_per_mbps_under_100_mbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_lit_fiber_internet_cost_per_mbps_under_100_mbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_lit_fiber_internet_cost_per_mbps_under_100_mbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_internet_circuits_under_100_mbps_n",
count(distinct (case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric <= 100 then line_item_id else null end)) as "lit_fiber_internet_line_items_under_100_mbps_n",  

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_lit_fiber_internet_cost_per_mbps_100_mbps_to_1_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_lit_fiber_internet_cost_per_mbps_100_mbps_to_1_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_lit_fiber_internet_cost_per_mbps_100_mbps_to_1_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_internet_circuits_100_mbps_to_1_Gbps_n",
count(distinct (case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then line_item_id else null end)) as "lit_fiber_internet_line_items_100_mbps_to_1_Gbps_n",

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_lit_fiber_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_lit_fiber_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_lit_fiber_internet_cost_per_mbps_1_Gbps_to_10_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_internet_circuits_1_Gbps_to_10_Gbps_n",
count(distinct (case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then line_item_id else null end)) as "lit_fiber_internet_line_items_1_Gbps_to_10_Gbps_n",

min(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "min_lit_fiber_internet_cost_per_mbps_over_10_Gbps",
avg(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "mean_lit_fiber_internet_cost_per_mbps_over_10_Gbps",
max(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then (circuit_cost::numeric/bandwidth_in_mbps::numeric)/12 else null end) as "max_lit_fiber_internet_cost_per_mbps_over_10_Gbps",
sum(case when internet_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_internet_circuits_over_10_Gbps_n",
count(distinct (case when internet_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 10000 then line_item_id else null end)) as "lit_fiber_internet_line_items_over_10_Gbps_n"

from circuit_list

GROUP BY applicant_postal_cd),

cl_pure_wan as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true

ORDER BY circuit_cost),


cl_pure_wan_under_100_mbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric <= 100

ORDER BY circuit_cost),




cl_pure_wan_100_mbps_to_1_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000

ORDER BY circuit_cost),


cl_pure_wan_1_Gbps_to_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000

ORDER BY circuit_cost),



cl_pure_wan_over_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 10000

ORDER BY circuit_cost),


cl_lf_wan as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_wan_under_100_mbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_wan_100_mbps_to_1_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_wan_1_Gbps_to_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

cl_lf_wan_over_10_Gbps as (
select applicant_postal_cd as "state",
bandwidth_in_mbps,
circuit_cost

from circuit_list

where wan_conditions_met=true and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service'

ORDER BY circuit_cost),

agg_functions as (

select circuit_list.applicant_postal_cd as "state",

min(case when internet_conditions_met=false then circuit_cost::numeric else null end) as "min_wan_cost_per_connection",
avg(case when internet_conditions_met=false then circuit_cost::numeric else null end) as "mean_wan_cost_per_connection",
max(case when internet_conditions_met=false then circuit_cost::numeric else null end) as "max_wan_cost_per_connection",
sum(case when internet_conditions_met=false then 1 else 0 end) as "wan_circuits_n",
count(distinct (case when internet_conditions_met=false then line_item_id else null end)) as "wan_line_items_n",  

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 then circuit_cost::numeric else null end) as "min_wan_cost_per_connection_under_100_mbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 then circuit_cost::numeric else null end) as "mean_wan_cost_per_connection_under_100_mbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 then circuit_cost::numeric else null end) as "max_wan_cost_per_connection_under_100_mbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 then 1 else 0 end) as "wan_circuits_under_100_mbps_n",
count(distinct (case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 then line_item_id else null end)) as "wan_line_items_under_100_mbps_n",

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then circuit_cost::numeric else null end) as "min_wan_cost_per_connection_100_mbps_to_1_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then circuit_cost::numeric else null end) as "mean_wan_cost_per_connection_100_mbps_to_1_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then circuit_cost::numeric else null end) as "max_wan_cost_per_connection_100_mbps_to_1_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then 1 else 0 end) as "wan_circuits_100_mbps_to_1_Gbps_n",
count(distinct (case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then line_item_id else null end)) as "wan_line_items_100_mbps_to_1_Gbps_n",

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then circuit_cost::numeric else null end) as "min_wan_cost_per_connection_1_Gbps_to_10_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then circuit_cost::numeric else null end) as "mean_wan_cost_per_connection_1_Gbps_to_10_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then circuit_cost::numeric else null end) as "max_wan_cost_per_connection_1_Gbps_to_10_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then 1 else 0 end) as "wan_circuits_1_Gbps_to_10_Gbps_n",
count(distinct (case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then line_item_id else null end)) as "wan_line_items_1_Gbps_to_10_Gbps_n",

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 then circuit_cost::numeric else null end) as "min_wan_cost_per_connection_over_10_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 then circuit_cost::numeric else null end) as "mean_wan_cost_per_connection_over_10_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 then circuit_cost::numeric else null end) as "max_wan_cost_per_connection_over_10_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 then 1 else 0 end) as "wan_circuits_over_10_Gbps_n",
count(distinct (case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 then line_item_id else null end)) as "wan_line_items_over_10_Gbps_n",


min(case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "min_lit_fiber_wan_cost_per_connection",
avg(case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "mean_lit_fiber_wan_cost_per_connection",
max(case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "max_lit_fiber_wan_cost_per_connection",
sum(case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_wan_circuits_n",
count(distinct (case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' then line_item_id else null end)) as "lit_fiber_wan_line_items_n",  

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "min_lit_fiber_wan_cost_per_connection_under_100_mbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "mean_lit_fiber_wan_cost_per_connection_under_100_mbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "max_lit_fiber_wan_cost_per_connection_under_100_mbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric <= 100 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_wan_circuits_under_100_mbps_n",
count(distinct (case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric <= 100 then line_item_id else null end)) as "lit_fiber_wan_line_items_under_100_mbps_n",  

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "min_lit_fiber_wan_cost_per_connection_100_mbps_to_1_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "mean_lit_fiber_wan_cost_per_connection_100_mbps_to_1_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "max_lit_fiber_wan_cost_per_connection_100_mbps_to_1_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_wan_circuits_100_mbps_to_1_Gbps_n",
count(distinct (case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 100 and bandwidth_in_mbps::numeric <= 1000 then line_item_id else null end)) as "lit_fiber_wan_line_items_100_mbps_to_1_Gbps_n",

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "min_lit_fiber_wan_cost_per_connection_1_Gbps_to_10_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "mean_lit_fiber_wan_cost_per_connection_1_Gbps_to_10_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "max_lit_fiber_wan_cost_per_connection_1_Gbps_to_10_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_wan_circuits_1_Gbps_to_10_Gbps_n",
count(distinct (case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 1000 and bandwidth_in_mbps::numeric <= 10000 then line_item_id else null end)) as "lit_fiber_wan_line_items_1_Gbps_to_10_Gbps_n",

min(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "min_lit_fiber_wan_cost_per_connection_over_10_Gbps",
avg(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "mean_lit_fiber_wan_cost_per_connection_over_10_Gbps",
max(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then circuit_cost::numeric else null end) as "max_lit_fiber_wan_cost_per_connection_over_10_Gbps",
sum(case when internet_conditions_met=false and bandwidth_in_mbps::numeric > 10000 and connect_category='Fiber' and connect_type!='Dark Fiber Service' then 1 else 0 end) as "lit_fiber_wan_circuits_over_10_Gbps_n",
count(distinct (case when internet_conditions_met=false and connect_category='Fiber' and connect_type!='Dark Fiber Service' and bandwidth_in_mbps::numeric > 10000 then line_item_id else null end)) as "lit_fiber_wan_line_items_over_10_Gbps_n"

from circuit_list

GROUP BY applicant_postal_cd),

wan_summary as (select agg_functions.*,
p_pure_wan."10th_percentile_wan_cost_per_connection",
p_pure_wan."25th_percentile_wan_cost_per_connection",
p_pure_wan."median_wan_cost_per_connection",
p_pure_wan."75th_percentile_wan_cost_per_connection",
p_pure_wan."90th_percentile_wan_cost_per_connection",

p_pure_wan_under_100_mbps."10th_percentile_wan_under_100_mbps_cost_per_connection",
p_pure_wan_under_100_mbps."25th_percentile_wan_under_100_mbps_cost_per_connection",
p_pure_wan_under_100_mbps."median_wan_under_100_mbps_cost_per_connection",
p_pure_wan_under_100_mbps."75th_percentile_wan_under_100_mbps_cost_per_connection",
p_pure_wan_under_100_mbps."90th_percentile_wan_under_100_mbps_cost_per_connection",

p_pure_wan_100_mbps_to_1_Gbps."10th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_pure_wan_100_mbps_to_1_Gbps."25th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_pure_wan_100_mbps_to_1_Gbps."median_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_pure_wan_100_mbps_to_1_Gbps."75th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_pure_wan_100_mbps_to_1_Gbps."90th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",

p_pure_wan_1_Gbps_to_10_Gbps."10th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_pure_wan_1_Gbps_to_10_Gbps."25th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_pure_wan_1_Gbps_to_10_Gbps."median_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_pure_wan_1_Gbps_to_10_Gbps."75th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_pure_wan_1_Gbps_to_10_Gbps."90th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",

ppw."10th_percentile_wan_over_10_Gbps_cost_per_connection",
ppw."25th_percentile_wan_over_10_Gbps_cost_per_connection",
ppw."median_wan_over_10_Gbps_cost_per_connection",
ppw."75th_percentile_wan_over_10_Gbps_cost_per_connection",
ppw."90th_percentile_wan_over_10_Gbps_cost_per_connection",

p_lf_wan."10th_percentile_lf_wan_cost_per_connection",
p_lf_wan."25th_percentile_lf_wan_cost_per_connection",
p_lf_wan."median_lf_wan_cost_per_connection",
p_lf_wan."75th_percentile_lf_wan_cost_per_connection",
p_lf_wan."90th_percentile_lf_wan_cost_per_connection",

p_lf_wan_under_100_mbps."10th_percentile_lf_wan_under_100_mbps_cost_per_connection",
p_lf_wan_under_100_mbps."25th_percentile_lf_wan_under_100_mbps_cost_per_connection",
p_lf_wan_under_100_mbps."median_lf_wan_under_100_mbps_cost_per_connection",
p_lf_wan_under_100_mbps."75th_percentile_lf_wan_under_100_mbps_cost_per_connection",
p_lf_wan_under_100_mbps."90th_percentile_lf_wan_under_100_mbps_cost_per_connection",

p_lf_wan_100_mbps_to_1_Gbps."10th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_lf_wan_100_mbps_to_1_Gbps."25th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_lf_wan_100_mbps_to_1_Gbps."median_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_lf_wan_100_mbps_to_1_Gbps."75th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
p_lf_wan_100_mbps_to_1_Gbps."90th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",

p_lf_wan_1_Gbps_to_10_Gbps."10th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_lf_wan_1_Gbps_to_10_Gbps."25th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_lf_wan_1_Gbps_to_10_Gbps."median_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_lf_wan_1_Gbps_to_10_Gbps."75th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
p_lf_wan_1_Gbps_to_10_Gbps."90th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",

p_lf_wan_over_10_Gbps."10th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
p_lf_wan_over_10_Gbps."25th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
p_lf_wan_over_10_Gbps."median_lf_wan_over_10_Gbps_cost_per_connection",
p_lf_wan_over_10_Gbps."75th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
p_lf_wan_over_10_Gbps."90th_percentile_lf_wan_over_10_Gbps_cost_per_connection"

from agg_functions

left join lateral (
select state,
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_wan_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_wan_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_wan_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_wan_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_wan_cost_per_connection"

from cl_pure_wan_under_100_mbps
GROUP BY state) p_pure_wan
on agg_functions.state=p_pure_wan.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_wan_under_100_mbps_cost_per_connection"

from cl_pure_wan_under_100_mbps
GROUP BY state) p_pure_wan_under_100_mbps
on agg_functions.state=p_pure_wan_under_100_mbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection"

from cl_pure_wan_100_mbps_to_1_Gbps
GROUP BY state) p_pure_wan_100_mbps_to_1_Gbps
on agg_functions.state=p_pure_wan_100_mbps_to_1_Gbps.state


left join lateral (

select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection"

from cl_pure_wan_1_Gbps_to_10_Gbps
GROUP BY state) p_pure_wan_1_Gbps_to_10_Gbps
on agg_functions.state=p_pure_wan_1_Gbps_to_10_Gbps.state


left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_wan_over_10_Gbps_cost_per_connection"

from cl_pure_wan_over_10_Gbps
GROUP BY state) ppw
on agg_functions.state=ppw.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_lf_wan_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_lf_wan_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_lf_wan_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_lf_wan_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_lf_wan_cost_per_connection"

from cl_lf_wan
GROUP BY state) p_lf_wan
on agg_functions.state=p_lf_wan.state 

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_lf_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_lf_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_lf_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_lf_wan_under_100_mbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_lf_wan_under_100_mbps_cost_per_connection"

from cl_lf_wan_under_100_mbps
GROUP BY state) p_lf_wan_under_100_mbps
on agg_functions.state=p_lf_wan_under_100_mbps.state


left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection"

from cl_lf_wan_100_mbps_to_1_Gbps
GROUP BY state) p_lf_wan_100_mbps_to_1_Gbps
on agg_functions.state=p_lf_wan_100_mbps_to_1_Gbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection"

from cl_lf_wan_1_Gbps_to_10_Gbps
GROUP BY state) p_lf_wan_1_Gbps_to_10_Gbps
on agg_functions.state=p_lf_wan_1_Gbps_to_10_Gbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "10th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "25th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "median_lf_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "75th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY circuit_cost::numeric) AS "90th_percentile_lf_wan_over_10_Gbps_cost_per_connection"

from cl_lf_wan_over_10_Gbps
GROUP BY state) p_lf_wan_over_10_Gbps
on agg_functions.state=p_lf_wan_over_10_Gbps.state

where agg_functions.state!='DC')


select agg_functions_ia.*,
p_pure_internet."10th_percentile_internet_cost_per_mbps",
p_pure_internet."25th_percentile_internet_cost_per_mbps",
p_pure_internet."median_internet_cost_per_mbps",
p_pure_internet."75th_percentile_internet_cost_per_mbps",
p_pure_internet."90th_percentile_internet_cost_per_mbps",

p_pure_internet_under_100_mbps."10th_percentile_internet_under_100_mbps_cost_per_mbps",
p_pure_internet_under_100_mbps."25th_percentile_internet_under_100_mbps_cost_per_mbps",
p_pure_internet_under_100_mbps."median_internet_under_100_mbps_cost_per_mbps",
p_pure_internet_under_100_mbps."75th_percentile_internet_under_100_mbps_cost_per_mbps",
p_pure_internet_under_100_mbps."90th_percentile_internet_under_100_mbps_cost_per_mbps",

p_pure_internet_100_mbps_to_1_Gbps."10th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_pure_internet_100_mbps_to_1_Gbps."25th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_pure_internet_100_mbps_to_1_Gbps."median_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_pure_internet_100_mbps_to_1_Gbps."75th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_pure_internet_100_mbps_to_1_Gbps."90th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",

p_pure_internet_1_Gbps_to_10_Gbps."10th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_pure_internet_1_Gbps_to_10_Gbps."25th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_pure_internet_1_Gbps_to_10_Gbps."median_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_pure_internet_1_Gbps_to_10_Gbps."75th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_pure_internet_1_Gbps_to_10_Gbps."90th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",

ppi."10th_percentile_internet_over_10_Gbps_cost_per_mbps",
ppi."25th_percentile_internet_over_10_Gbps_cost_per_mbps",
ppi."median_internet_over_10_Gbps_cost_per_mbps",
ppi."75th_percentile_internet_over_10_Gbps_cost_per_mbps",
ppi."90th_percentile_internet_over_10_Gbps_cost_per_mbps",

p_lf_internet."10th_percentile_lf_internet_cost_per_mbps",
p_lf_internet."25th_percentile_lf_internet_cost_per_mbps",
p_lf_internet."median_lf_internet_cost_per_mbps",
p_lf_internet."75th_percentile_lf_internet_cost_per_mbps",
p_lf_internet."90th_percentile_lf_internet_cost_per_mbps",

p_lf_internet_under_100_mbps."10th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
p_lf_internet_under_100_mbps."25th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
p_lf_internet_under_100_mbps."median_lf_internet_under_100_mbps_cost_per_mbps",
p_lf_internet_under_100_mbps."75th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
p_lf_internet_under_100_mbps."90th_percentile_lf_internet_under_100_mbps_cost_per_mbps",

p_lf_internet_100_mbps_to_1_Gbps."10th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_lf_internet_100_mbps_to_1_Gbps."25th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_lf_internet_100_mbps_to_1_Gbps."median_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_lf_internet_100_mbps_to_1_Gbps."75th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
p_lf_internet_100_mbps_to_1_Gbps."90th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",

p_lf_internet_1_Gbps_to_10_Gbps."10th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_lf_internet_1_Gbps_to_10_Gbps."25th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_lf_internet_1_Gbps_to_10_Gbps."median_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_lf_internet_1_Gbps_to_10_Gbps."75th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
p_lf_internet_1_Gbps_to_10_Gbps."90th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",

p_lf_internet_over_10_Gbps."10th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
p_lf_internet_over_10_Gbps."25th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
p_lf_internet_over_10_Gbps."median_lf_internet_over_10_Gbps_cost_per_mbps",
p_lf_internet_over_10_Gbps."75th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
p_lf_internet_over_10_Gbps."90th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",

agg_functions.*,

wan_summary."10th_percentile_wan_cost_per_connection",
wan_summary."25th_percentile_wan_cost_per_connection",
wan_summary."median_wan_cost_per_connection",
wan_summary."75th_percentile_wan_cost_per_connection",
wan_summary."90th_percentile_wan_cost_per_connection",

wan_summary."10th_percentile_wan_under_100_mbps_cost_per_connection",
wan_summary."25th_percentile_wan_under_100_mbps_cost_per_connection",
wan_summary."median_wan_under_100_mbps_cost_per_connection",
wan_summary."75th_percentile_wan_under_100_mbps_cost_per_connection",
wan_summary."90th_percentile_wan_under_100_mbps_cost_per_connection",

wan_summary."10th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."25th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."median_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."75th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."90th_percentile_wan_100_mbps_to_1_Gbps_cost_per_connection",

wan_summary."10th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."25th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."median_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."75th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."90th_percentile_wan_1_Gbps_to_10_Gbps_cost_per_connection",

wan_summary."10th_percentile_wan_over_10_Gbps_cost_per_connection",
wan_summary."25th_percentile_wan_over_10_Gbps_cost_per_connection",
wan_summary."median_wan_over_10_Gbps_cost_per_connection",
wan_summary."75th_percentile_wan_over_10_Gbps_cost_per_connection",
wan_summary."90th_percentile_wan_over_10_Gbps_cost_per_connection",

wan_summary."10th_percentile_lf_wan_cost_per_connection",
wan_summary."25th_percentile_lf_wan_cost_per_connection",
wan_summary."median_lf_wan_cost_per_connection",
wan_summary."75th_percentile_lf_wan_cost_per_connection",
wan_summary."90th_percentile_lf_wan_cost_per_connection",

wan_summary."10th_percentile_lf_wan_under_100_mbps_cost_per_connection",
wan_summary."25th_percentile_lf_wan_under_100_mbps_cost_per_connection",
wan_summary."median_lf_wan_under_100_mbps_cost_per_connection",
wan_summary."75th_percentile_lf_wan_under_100_mbps_cost_per_connection",
wan_summary."90th_percentile_lf_wan_under_100_mbps_cost_per_connection",

wan_summary."10th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."25th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."median_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."75th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",
wan_summary."90th_percentile_lf_wan_100_mbps_to_1_Gbps_cost_per_connection",

wan_summary."10th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."25th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."median_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."75th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",
wan_summary."90th_percentile_lf_wan_1_Gbps_to_10_Gbps_cost_per_connection",

wan_summary."10th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
wan_summary."25th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
wan_summary."median_lf_wan_over_10_Gbps_cost_per_connection",
wan_summary."75th_percentile_lf_wan_over_10_Gbps_cost_per_connection",
wan_summary."90th_percentile_lf_wan_over_10_Gbps_cost_per_connection"



from agg_functions_ia

left join lateral (
select state,
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_internet_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_internet_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_internet_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_internet_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_internet_cost_per_mbps"

from cl_pure_internet_under_100_mbps
GROUP BY state) p_pure_internet
on agg_functions_ia.state=p_pure_internet.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_internet_under_100_mbps_cost_per_mbps"

from cl_pure_internet_under_100_mbps
GROUP BY state) p_pure_internet_under_100_mbps
on agg_functions_ia.state=p_pure_internet_under_100_mbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_internet_100_mbps_to_1_Gbps_cost_per_mbps"

from cl_pure_internet_100_mbps_to_1_Gbps
GROUP BY state) p_pure_internet_100_mbps_to_1_Gbps
on agg_functions_ia.state=p_pure_internet_100_mbps_to_1_Gbps.state


left join lateral (

select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_internet_1_Gbps_to_10_Gbps_cost_per_mbps"

from cl_pure_internet_1_Gbps_to_10_Gbps
GROUP BY state) p_pure_internet_1_Gbps_to_10_Gbps
on agg_functions_ia.state=p_pure_internet_1_Gbps_to_10_Gbps.state


left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_internet_over_10_Gbps_cost_per_mbps"

from cl_pure_internet_over_10_Gbps
GROUP BY state) ppi
on agg_functions_ia.state=ppi.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_lf_internet_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_lf_internet_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_lf_internet_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_lf_internet_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_lf_internet_cost_per_mbps"

from cl_lf_internet
GROUP BY state) p_lf_internet
on agg_functions_ia.state=p_lf_internet.state 

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_lf_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_lf_internet_under_100_mbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_lf_internet_under_100_mbps_cost_per_mbps"

from cl_lf_internet_under_100_mbps
GROUP BY state) p_lf_internet_under_100_mbps
on agg_functions_ia.state=p_lf_internet_under_100_mbps.state


left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_lf_internet_100_mbps_to_1_Gbps_cost_per_mbps"

from cl_lf_internet_100_mbps_to_1_Gbps
GROUP BY state) p_lf_internet_100_mbps_to_1_Gbps
on agg_functions_ia.state=p_lf_internet_100_mbps_to_1_Gbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_lf_internet_1_Gbps_to_10_Gbps_cost_per_mbps"

from cl_lf_internet_1_Gbps_to_10_Gbps
GROUP BY state) p_lf_internet_1_Gbps_to_10_Gbps
on agg_functions_ia.state=p_lf_internet_1_Gbps_to_10_Gbps.state

left join lateral (
select state, 
PERCENTILE_CONT (0.1) WITHIN GROUP (ORDER BY cost_per_mbps) AS "10th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY cost_per_mbps) AS "25th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.5) WITHIN GROUP (ORDER BY cost_per_mbps) AS "median_lf_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.75) WITHIN GROUP (ORDER BY cost_per_mbps) AS "75th_percentile_lf_internet_over_10_Gbps_cost_per_mbps",
PERCENTILE_CONT (0.9) WITHIN GROUP (ORDER BY cost_per_mbps) AS "90th_percentile_lf_internet_over_10_Gbps_cost_per_mbps"

from cl_lf_internet_over_10_Gbps
GROUP BY state) p_lf_internet_over_10_Gbps
on agg_functions_ia.state=p_lf_internet_over_10_Gbps.state

join wan_summary
on agg_functions_ia.state=wan_summary.state

join agg_functions
on agg_functions_ia.state=agg_functions.state

where agg_functions_ia.state!='DC'
